---
- name: 41) Initializing Kubernetes cluster
  become: yes
  ansible.builtin.shell: |
     kubeadm init --pod-network-cidr=10.244.0.0/16  --upload-certs --kubernetes-version=v1.28.0  --control-plane-endpoint=167.235.50.166 --cri-socket unix:///var/run/cri-dockerd.sock >> cluster_initialized.txt
  args:
    executable: /bin/bash
    chdir: "{{ ansible_env.HOME }}"
    creates: cluster_initialized.txt
  register: kubeadm_result
  failed_when:
    - "'error' in kubeadm_result.stderr|lower"
    - "kubeadm_result.rc != 0"


- name: 42) Set up kubeconfig
  block:
    - name: Ensure .kube directory exists
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.kube"
        state: directory
        owner: admin
        mode: '0755'
      become: yes
      become_user: admin

    - name: Copy Kubernetes admin config to user's kubeconfig
      ansible.builtin.copy:
        src: /etc/kubernetes/admin.conf
        dest: "{{ ansible_env.HOME }}/.kube/config"
        owner: admin
        mode: '0644'
      become: yes
  become_user: admin



- name: 43) Set owner of kube config
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.kube/config"
    owner: admin
    group: admin
    mode: '0600'
  become: yes



- name: 44) Set KUBECONFIG environment variable
  become: true
  ansible.builtin.lineinfile:
    path: $HOME/.bashrc
    line: export KUBECONFIG=/etc/kubernetes/admin.conf


- name: 45) Install flannel pod network
  become: true
  ansible.builtin.shell: kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
  args:
    chdir: $HOME


- name: 46) Copy join command to local file.
  become: true
  delegate_to: localhost
  copy:
    content: "{{ kubernetes_join_command.stdout_lines[0] }}"
    dest: "/tmp/kubernetes_join_command"
    mode: 0777

- name: 47) Get the token for joining the worker nodes
  become: true
  become_user: admin
  ansible.builtin.shell: kubeadm token create  --print-join-command
  register: kubernetes_join_command
  changed_when: false

